<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>TravelTalk - 五國語言全功能版 (搜尋+收藏)</title>

    <!-- PWA Meta Tags -->
    <link rel="manifest" href="/manifest.json">
    <meta name="theme-color" content="#2563eb">

    <!-- Apple Touch Icon -->
    <link rel="apple-touch-icon" href="/icons/apple-touch-icon-180x180.png">
    <link rel="apple-touch-icon" sizes="152x152" href="/icons/apple-touch-icon-152x152.png">
    <link rel="apple-touch-icon" sizes="167x167" href="/icons/apple-touch-icon-167x167.png">
    <link rel="apple-touch-icon" sizes="180x180" href="/icons/apple-touch-icon-180x180.png">

    <!-- iOS Safari 配置 -->
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="apple-mobile-web-app-title" content="TravelTalk">

    <!-- Microsoft Tiles -->
    <meta name="msapplication-TileImage" content="/icons/icon-144x144.png">
    <meta name="msapplication-TileColor" content="#2563eb">
    <meta name="msapplication-config" content="/browserconfig.xml">

    <!-- SEO 增強 -->
    <meta name="description" content="TravelTalk 是專為台灣旅客設計的多語言翻譯應用，提供中文、英文、日文、韓文、泰文五國語言即時翻譯，支援離線使用和語音播放">
    <meta name="keywords" content="旅遊翻譯,多語言,中英日韓泰,離線翻譯,語音播放,TravelTalk">

    <!-- Favicon -->
    <link rel="icon" type="image/png" sizes="32x32" href="/icons/favicon-32x32.png">
    <link rel="icon" type="image/png" sizes="16x16" href="/icons/favicon-16x16.png">
    <link rel="shortcut icon" href="/icons/favicon.ico">

    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- Fonts -->
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+TC:wght@400;700&family=Noto+Sans+JP:wght@400;700&family=Noto+Sans+KR:wght@400;700&family=Kanit:wght@400;700&display=swap" rel="stylesheet">
    
    <!-- Icons -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">

    <!-- Google Analytics 4 (延遲載入) -->
    <script>
        // 延遲載入 GA，避免阻塞渲染
        window.addEventListener('load', () => {
            const script = document.createElement('script');
            script.async = true;
            script.src = 'https://www.googletagmanager.com/gtag/js?id=G-K4KQF3YMT0';
            document.head.appendChild(script);

            window.dataLayer = window.dataLayer || [];
            function gtag(){dataLayer.push(arguments);}
            gtag('js', new Date());
            gtag('config', 'G-K4KQF3YMT0');
        });
    </script>

    <style>
        body { font-family: 'Noto Sans TC', sans-serif; background-color: #f3f4f6; -webkit-tap-highlight-color: transparent; }
        .font-jp { font-family: 'Noto Sans JP', sans-serif; }
        .font-kr { font-family: 'Noto Sans KR', sans-serif; }
        .font-th { font-family: 'Kanit', sans-serif; }
        .no-scrollbar::-webkit-scrollbar { display: none; }
        .no-scrollbar { -ms-overflow-style: none; scrollbar-width: none; }
        
        .tab-active {
            background-color: #2563eb;
            color: white;
            border-color: #2563eb;
        }
        .tab-inactive {
            background-color: #1f2937;
            color: #9ca3af;
            border-color: #374151;
        }
    </style>
</head>
<body class="h-screen flex flex-col overflow-hidden max-w-md mx-auto bg-white shadow-xl relative">

    <!-- Header -->
    <header class="bg-blue-600 text-white p-4 pb-2 flex justify-between items-center shadow-md z-20 shrink-0">
        <div class="flex items-center gap-2">
            <i class="fa-solid fa-comments text-2xl"></i>
            <div>
                <h1 class="text-xl font-bold leading-none">TravelTalk</h1>
                <p class="text-[10px] text-blue-100 opacity-90">台灣視角出發 • 中英日韓泰交流助手</p>
            </div>
        </div>
        <button onclick="showInfo()" class="text-white hover:text-blue-200"><i class="fa-solid fa-circle-info text-xl"></i></button>
    </header>

    <!-- Search Bar -->
    <div class="bg-blue-600 px-4 pb-4 pt-1 z-10 shrink-0">
        <div class="relative">
            <i class="fa-solid fa-magnifying-glass absolute left-3 top-1/2 transform -translate-y-1/2 text-gray-400"></i>
            <input type="text" id="search-input" placeholder="搜尋關鍵字 (例如: 廁所, price)" 
                class="w-full pl-10 pr-4 py-2 rounded-lg text-sm text-gray-800 placeholder-gray-400 focus:outline-none focus:ring-2 focus:ring-blue-300 shadow-inner"
                oninput="handleSearch()">
            <button id="clear-search" onclick="clearSearch()" class="absolute right-2 top-1/2 transform -translate-y-1/2 text-gray-400 hover:text-gray-600 hidden">
                <i class="fa-solid fa-circle-xmark"></i>
            </button>
        </div>
    </div>

    <!-- Categories -->
    <div class="bg-white border-b border-gray-200 shrink-0">
        <div class="flex overflow-x-auto no-scrollbar p-2 space-x-2" id="category-container"></div>
    </div>

    <!-- Content List -->
    <main class="flex-1 overflow-y-auto p-4 bg-gray-50 pb-24" id="content-list"></main>

    <!-- Footer -->
    <footer class="bg-gray-100 text-gray-500 text-xs text-center p-2 border-t shrink-0">
        <p>點擊卡片開啟對話 • 點擊 <i class="fa-regular fa-star text-yellow-500"></i> 加入常用</p>
    </footer>

    <!-- MAIN MODAL -->
    <div id="translation-modal" onclick="if(event.target === this) closeModal()" class="fixed inset-0 z-50 hidden bg-black/70 flex-col justify-start items-center p-6 text-white transition-all duration-300 backdrop-blur-sm pt-8 overflow-y-auto cursor-pointer">

        <button onclick="closeModal()" class="fixed top-4 right-4 w-10 h-10 flex items-center justify-center bg-gray-700/80 rounded-full text-white hover:bg-gray-600 z-[60] shadow-lg border border-gray-500 backdrop-blur-md">
            <i class="fa-solid fa-xmark text-xl"></i>
        </button>

        <div class="w-full max-w-sm space-y-4 text-center relative mt-6 cursor-auto pb-12">
            
            <div id="modal-switcher" class="hidden grid-cols-4 gap-2 mb-4"></div>

            <div class="border-b border-gray-700 pb-2 mb-2 flex flex-col items-center">
                <p class="text-gray-400 text-xs mb-1">您的意思 / You mean</p>
                <h2 id="modal-zh" class="text-2xl font-bold text-white leading-snug">中文內容</h2>
            </div>

            <!-- Language Cards -->
            <div onclick="playAudio('en')" class="bg-gray-800 p-3 rounded-xl cursor-pointer hover:bg-gray-700 border border-gray-700 active:scale-[0.98] transition shadow-lg relative group">
                <div class="flex justify-between items-start mb-1">
                    <span class="text-[10px] text-green-400 font-bold uppercase tracking-wider bg-green-900/30 px-2 py-0.5 rounded">English</span>
                    <i class="fa-solid fa-volume-high text-green-400/50 group-hover:text-green-400 transition"></i>
                </div>
                <p id="modal-en" class="text-lg font-bold text-gray-100 leading-snug text-left">English Text</p>
            </div>

            <div onclick="playAudio('ja')" class="bg-gray-800 p-3 rounded-xl cursor-pointer hover:bg-gray-700 border border-gray-700 active:scale-[0.98] transition shadow-lg relative group">
                <div class="flex justify-between items-start mb-1">
                    <span class="text-[10px] text-pink-400 font-bold uppercase tracking-wider bg-pink-900/30 px-2 py-0.5 rounded">日本語</span>
                    <i class="fa-solid fa-volume-high text-pink-400/50 group-hover:text-pink-400 transition"></i>
                </div>
                <p id="modal-jp" class="text-xl font-bold font-jp text-gray-100 leading-snug text-left">日本語テキスト</p>
            </div>

            <div onclick="playAudio('ko')" class="bg-gray-800 p-3 rounded-xl cursor-pointer hover:bg-gray-700 border border-gray-700 active:scale-[0.98] transition shadow-lg relative group">
                <div class="flex justify-between items-start mb-1">
                    <span class="text-[10px] text-yellow-400 font-bold uppercase tracking-wider bg-yellow-900/30 px-2 py-0.5 rounded">한국어</span>
                    <i class="fa-solid fa-volume-high text-yellow-400/50 group-hover:text-yellow-400 transition"></i>
                </div>
                <p id="modal-kr" class="text-xl font-bold font-kr text-gray-100 leading-snug text-left">한국어 텍스트</p>
            </div>

            <div onclick="playAudio('th')" class="bg-gray-800 p-3 rounded-xl cursor-pointer hover:bg-gray-700 border border-gray-700 active:scale-[0.98] transition shadow-lg relative group">
                <div class="flex justify-between items-start mb-1">
                    <span class="text-[10px] text-purple-400 font-bold uppercase tracking-wider bg-purple-900/30 px-2 py-0.5 rounded">ภาษาไทย</span>
                    <i class="fa-solid fa-volume-high text-purple-400/50 group-hover:text-purple-400 transition"></i>
                </div>
                <p id="modal-th" class="text-xl font-bold font-th text-gray-100 leading-snug text-left">ข้อความภาษาไทย</p>
            </div>
            
        </div>
    </div>

    <!-- Info Modal -->
    <div id="info-modal" onclick="if(event.target === this) document.getElementById('info-modal').classList.add('hidden')" class="fixed inset-0 z-50 hidden bg-black/50 flex justify-center items-center p-4 backdrop-blur-sm cursor-pointer">
        <div class="bg-white rounded-xl p-6 max-w-sm w-full shadow-2xl cursor-auto relative max-h-[90vh] overflow-y-auto">
            <h3 class="text-xl font-bold text-gray-800 mb-2">使用說明</h3>
            <ul class="list-disc list-inside text-gray-600 text-sm space-y-1 mb-4">
                <li><i class="fa-solid fa-star text-yellow-500"></i> 點擊星星可加入「常用」列表，並置頂顯示。</li>
                <li><i class="fa-solid fa-magnifying-glass text-gray-400"></i> 上方搜尋框可快速查找對話。</li>
                <li>支援中、英、日、韓、泰五語發音。</li>
            </ul>

            <!-- PWA 安裝教學區塊 -->
            <div id="pwa-install-section" class="bg-green-50 border-l-4 border-green-500 p-4 mt-3 rounded-xl">
                <p class="text-green-800 text-xs font-bold mb-3 flex items-center gap-2">
                    <i class="fa-solid fa-mobile-screen-button text-green-600"></i>
                    安裝到主畫面
                </p>

                <div id="pwa-ios-section" class="mb-2">
                    <p class="text-green-700 text-xs font-semibold mb-1">iPhone / iPad:</p>
                    <p class="text-green-600 text-[11px] leading-relaxed">
                        點選瀏覽器下方的「分享」按鈕，選擇「加入主畫面」即可快速開啟應用。支援離線使用！
                    </p>
                </div>

                <div id="pwa-android-section">
                    <p class="text-green-700 text-xs font-semibold mb-1">Android:</p>
                    <p class="text-green-600 text-[11px] leading-relaxed">
                        瀏覽器會自動提示安裝。點擊「安裝」將應用新增至主畫面，隨時可用。
                    </p>
                </div>

                <p class="text-green-500 text-[10px] mt-2 flex items-center gap-1">
                    <i class="fa-solid fa-lightbulb"></i>
                    離線時也能翻譯，更省流量！
                </p>
            </div>

            <div class="bg-orange-50 border-l-4 border-orange-400 p-3 mt-3 rounded">
                <p class="text-orange-800 text-xs font-bold mb-2">📱 語音包下載提醒</p>
                <p class="text-orange-700 text-xs">• iPhone: 設定 > 輔助使用 > 語音內容 > 聲音</p>
                <p class="text-orange-700 text-xs">• Android: 設定 > 系統 > 語言和輸入 > 文字轉語音輸出</p>
                <p class="text-orange-600 text-[10px] mt-2">*若無聲音或發音錯誤，請確認已下載對應語言的語音包</p>
            </div>

            <button onclick="checkVoiceAvailability()" class="w-full bg-gray-600 text-white py-3 rounded-lg font-bold mt-3 flex items-center justify-center gap-2">
                <i class="fa-solid fa-check-circle"></i>
                檢測語音包安裝狀態
            </button>

            <!-- 建議功能 -->
            <div class="mt-4 p-4 bg-blue-50 rounded-lg border border-blue-200">
                <p class="text-sm font-bold text-gray-800 mb-2">💡 希望新增什麼對話場景？</p>
                <p class="text-xs text-gray-600 mb-3">您的建議將幫助我們改進 TravelTalk</p>
                <textarea id="suggestion-input"
                    placeholder="例如：在郵局寄包裹、租借腳踏車..."
                    class="w-full p-2 text-sm border border-gray-300 rounded-lg resize-none focus:outline-none focus:ring-2 focus:ring-blue-400"
                    rows="2"
                    maxlength="100"></textarea>
                <p class="text-xs text-gray-400 mt-1">
                    <i class="fa-solid fa-shield-halved"></i> 此為匿名統計，請勿輸入個人資料
                </p>
                <div id="suggestion-warning" class="hidden mt-2 p-2 bg-yellow-50 border border-yellow-300 rounded text-xs text-yellow-800">
                    <i class="fa-solid fa-triangle-exclamation"></i> <span id="suggestion-warning-text"></span>
                </div>
                <button onclick="submitSuggestion()" class="w-full bg-green-600 text-white py-2 rounded-lg font-bold mt-3 text-sm">
                    <i class="fa-solid fa-paper-plane"></i> 送出建議
                </button>
            </div>

            <button onclick="document.getElementById('info-modal').classList.add('hidden')" class="w-full bg-blue-600 text-white py-3 rounded-lg font-bold mt-4">了解</button>
            
            <!-- Version Number -->
            <p class="text-gray-300 text-[10px] text-center mt-3">Ver 1.0.0</p>
        </div>
    </div>

    <script>
        // --- 核心資料庫 (加入唯一 ID) ---
        // ID 命名規則：category-keyword (例如: interaction-welcome)
        const phrases = [
            // --- 互動/溝通 (Interaction) ---
            { 
                id: 'int-welcome',
                category: 'interaction', 
                isDynamic: true,
                title: '歡迎來到...(國家)', 
                options: [
                    { label: '台灣', zh: '歡迎來到台灣！', en: 'Welcome to Taiwan!', jp: '台湾へようこそ！', kr: '대만에 오신 것을 환영합니다!', th: 'ยินดีต้อนรับสู่ไต้หวัน!' },
                    { label: '日本', zh: '歡迎來到日本！', en: 'Welcome to Japan!', jp: '日本へようこそ！', kr: '일본에 오신 것을 환영합니다!', th: 'ยินดีต้อนรับสู่ญี่ปุ่น!' },
                    { label: '韓國', zh: '歡迎來到韓國！', en: 'Welcome to Korea!', jp: '韓国へようこそ！', kr: '한국에 오신 것을 환영합니다!', th: 'ยินดีต้อนรับสู่เกาหลี!' },
                    { label: '泰國', zh: '歡迎來到泰國！', en: 'Welcome to Thailand!', jp: 'タイへようこそ！', kr: '태국에 오신 것을 환영합니다!', th: 'ยินดีต้อนรับสู่ประเทศไทย!' },
                    { label: '美國', zh: '歡迎來到美國！', en: 'Welcome to the USA!', jp: 'アメリカへようこそ！', kr: '미국에 오신 것을 환영합니다!', th: 'ยินดีต้อนรับสู่อเมริกา!' }
                ]
            },
            { 
                id: 'int-speak-lang',
                category: 'interaction', 
                isDynamic: true,
                title: '你會說...(語言)嗎？', 
                options: [
                    { label: '中文', zh: '你會說中文嗎？', en: 'Do you speak Chinese?', jp: '中国語を話せますか？', kr: '중국어 하세요?', th: 'คุณพูดภาษาจีนได้ไหม?' },
                    { label: '英文', zh: '你會說英文嗎？', en: 'Do you speak English?', jp: '英語を話せますか？', kr: '영어 하세요?', th: 'คุณพูดภาษาอังกฤษได้ไหม?' },
                    { label: '日文', zh: '你會說日文嗎？', en: 'Do you speak Japanese?', jp: '日本語を話せますか？', kr: '일본어 하세요?', th: 'คุณพูดภาษาญี่ปุ่นได้ไหม?' },
                    { label: '韓文', zh: '你會說韓文嗎？', en: 'Do you speak Korean?', jp: '한국어 하세요?', th: 'คุณพูดภาษาเกาหลีได้ไหม?' },
                    { label: '泰文', zh: '你會說泰文嗎？', en: 'Do you speak Thai?', jp: 'タイ語を話せますか？', kr: '태국어 하세요?', th: 'คุณพูดภาษาไทยได้ไหม?' }
                ]
            },
            { 
                id: 'int-cant-speak',
                category: 'interaction', 
                isDynamic: true,
                title: '我不會說...(語言)', 
                options: [
                    { label: '中文', zh: '我不會說中文', en: 'I don\'t speak Chinese.', jp: '中国語は話せません。', kr: '중국어를 못합니다.', th: 'ฉันพูดภาษาจีนไม่ได้' },
                    { label: '英文', zh: '我不會說英文', en: 'I don\'t speak English.', jp: '英語は話せません。', kr: '영어를 못합니다.', th: 'ฉันพูดภาษาอังกฤษไม่ได้' },
                    { label: '日文', zh: '我不會說日文', en: 'I don\'t speak Japanese.', jp: '日本語は話せません。', kr: '일본어를 못합니다.', th: 'ฉันพูดภาษาญี่ปุ่นไม่ได้' },
                    { label: '韓文', zh: '我不會說韓文', en: 'I don\'t speak Korean.', jp: '한국어를 못합니다.', th: 'ฉันพูดภาษาเกาหลีไม่ได้' },
                    { label: '泰文', zh: '我不會說泰文', en: 'I don\'t speak Thai.', jp: 'タイ語は話せません。', kr: '태국어를 못합니다.', th: 'ฉันพูดภาษาไทยไม่ได้' }
                ]
            },
            { 
                id: 'int-pls-speak',
                category: 'interaction', 
                isDynamic: true,
                title: '請說...(語言)', 
                options: [
                    { label: '中文', zh: '請說中文', en: 'Please speak Chinese.', jp: '中国語で話してください。', kr: '중국어로 말해주세요.', th: 'กรุณาพูดภาษาจีน' },
                    { label: '英文', zh: '請說英文', en: 'Please speak English.', jp: '英語で話してください。', kr: '영어로 말해주세요.', th: 'กรุณาพูดภาษาอังกฤษ' },
                    { label: '慢一點', zh: '請說慢一點', en: 'Please speak slowly.', jp: 'もっとゆっくり話してください。', kr: '천천히 말해주세요.', th: 'กรุณาพูดช้าๆ' },
                    { label: '泰文', zh: '請說泰文', en: 'Please speak Thai.', jp: 'タイ語で話してください。', kr: '태국어로 말해주세요.', th: 'กรุณาพูดภาษาไทย' }
                ]
            },
            { id: 'int-dont-understand', category: 'interaction', zh: '我聽不懂', en: 'I don\'t understand.', jp: 'わかりません。', kr: '이해를 못 했어요.', th: 'ฉันไม่เข้าใจ' },
            { id: 'int-google-trans', category: 'interaction', zh: '請用Google翻譯', en: 'Please use Google Translate.', jp: 'Google翻訳を使ってください。', kr: '구글 번역기를 사용해주세요.', th: 'กรุณาใช้ Google Translate' },

            // --- 餐廳/飲食 (Dining) ---
            {
                id: 'dine-people',
                category: 'dining',
                isDynamic: true,
                title: '我們有...位 (人數)',
                options: [
                    { label: '1位', zh: '一位', en: 'Table for one.', jp: '1名です。', kr: '한 명입니다.', th: '1 ท่าน' },
                    { label: '2位', zh: '兩位', en: 'Table for two.', jp: '2名です。', kr: '두 명입니다.', th: '2 ท่าน' },
                    { label: '3位', zh: '三位', en: 'Table for three.', jp: '3名です。', kr: '세 명입니다.', th: '3 ท่าน' },
                    { label: '4位', zh: '四位', en: 'Table for four.', jp: '4名です。', kr: '네 명입니다.', th: '4 ท่าน' },
                    { label: '5位', zh: '五位', en: 'Table for five.', jp: '5名です。', kr: '다섯 명입니다.', th: '5 ท่าน' },
                    { label: '6位', zh: '六位', en: 'Table for six.', jp: '6名です。', kr: '여섯 명입니다.', th: '6 ท่าน' },
                    { label: '7位', zh: '七位', en: 'Table for seven.', jp: '7名です。', kr: '일곱 명입니다.', th: '7 ท่าน' },
                    { label: '8位', zh: '八位', en: 'Table for eight.', jp: '8名です。', kr: '여덟 명입니다.', th: '8 ท่าน' }
                ]
            },
            { id: 'dine-menu', category: 'dining', zh: '請給我菜單', en: 'Menu, please.', jp: 'メニューをください。', kr: '메뉴판 주세요.', th: 'ขอเมนูหน่อย' },
            { id: 'dine-recommend', category: 'dining', zh: '請推薦好吃的', en: 'What do you recommend?', jp: 'おすすめは何ですか？', kr: '추천 메뉴 있나요?', th: 'มีอะไรแนะนำบ้าง?' },
            { 
                id: 'dine-diet',
                category: 'dining', 
                isDynamic: true,
                title: '我不吃... (飲食禁忌)', 
                options: [
                    { label: '生食', zh: '我不吃生食', en: 'I don\'t eat raw food.', jp: '生ものは食べられません。', kr: '날것은 못 먹습니다.', th: 'ฉันไม่กินของดิบ' }, 
                    { label: '豬肉', zh: '我不吃豬肉', en: 'I don\'t eat pork.', jp: '豚肉は食べられません。', kr: '돼지고기는 못 먹습니다.', th: 'ฉันไม่กินหมู' },
                    { label: '牛肉', zh: '我不吃牛肉', en: 'I don\'t eat beef.', jp: '牛肉は食べられません。', kr: '소고기는 못 먹습니다.', th: 'ฉันไม่กินเนื้อวัว' },
                    { label: '海鮮', zh: '我不吃海鮮', en: 'I don\'t eat seafood.', jp: 'シーフードは食べられません。', kr: '해산물은 못 먹습니다.', th: 'ฉันไม่กินอาหารทะเล' },
                    { label: '吃素', zh: '我吃素', en: 'I am vegetarian.', jp: 'ベジタリアンです。', kr: '저는 채식주의자입니다.', th: 'ฉันกินเจ' }
                ]
            },
            { id: 'dine-no-coriander', category: 'dining', zh: '不要香菜', en: 'No coriander / cilantro.', jp: 'パクチー抜きでお願いします。', kr: '고수는 빼주세요.', th: 'ไม่ใส่ผักชี' },
            { id: 'dine-spicy', category: 'dining', zh: '這會辣嗎？', en: 'Is this spicy?', jp: 'これは辛いですか？', kr: '이거 매워요?', th: 'เผ็ดไหม?' },
            { id: 'dine-water', category: 'dining', zh: '請給我水', en: 'Water, please.', jp: 'お水をください。', kr: '물 좀 주세요.', th: 'ขอน้ำเปล่าหน่อย' },
            { id: 'dine-check', category: 'dining', zh: '我要結帳', en: 'Check, please.', jp: 'お会計をお願いします。', kr: '계산해 주세요.', th: 'เก็บตังค์ด้วย / เช็คบิล' },
            { id: 'dine-delicious', category: 'dining', zh: '很好吃', en: 'It was delicious.', jp: '美味しかったです。', kr: '맛있었어요.', th: 'อร่อยมาก' },

            // 訂位
            { id: 'dine-reservation', category: 'dining', zh: '我有訂位', en: 'I have a reservation.', jp: '予約しています。', kr: '예약했어요.', th: 'ฉันจองไว้แล้ว' },
            { id: 'dine-name', category: 'dining', zh: '訂位名字是...', en: 'Reservation under...', jp: '予約の名前は...', kr: '예약 이름은...', th: 'จองในนาม...' },

            // 點餐
            { id: 'dine-order-this', category: 'dining', zh: '我要點這個', en: 'I\'ll have this.', jp: 'これをください。', kr: '이거 주세요.', th: 'ขอเมนูนี้' },
            {
                id: 'dine-without',
                category: 'dining',
                isDynamic: true,
                title: '不要/少...（調味）',
                options: [
                    { label: '不辣', zh: '不要辣', en: 'No spicy.', jp: '辛くしないでください。', kr: '맵지 않게 해주세요.', th: 'ไม่เผ็ด' },
                    { label: '少鹽', zh: '少鹽', en: 'Less salt.', jp: '塩を少なめで。', kr: '싱겁게 해주세요.', th: 'เกลือน้อย' },
                    { label: '去冰', zh: '去冰', en: 'No ice.', jp: '氷なしで。', kr: '얼음 빼주세요.', th: 'ไม่ใส่น้ำแข็ง' },
                    { label: '少糖', zh: '少糖/半糖', en: 'Less sugar / Half sugar.', jp: '砂糖を減らして。', kr: '덜 달게 해주세요.', th: 'หวานน้อย' }
                ]
            },
            { id: 'dine-one-more', category: 'dining', zh: '再來一份這個', en: 'One more of this, please.', jp: 'これをもう一つください。', kr: '이거 하나 더 주세요.', th: 'ขอเมนูนี้อีกหนึ่งที่' },

            // 餐具
            {
                id: 'dine-utensils',
                category: 'dining',
                isDynamic: true,
                title: '請給我...（餐具）',
                options: [
                    { label: '筷子', zh: '請給我筷子', en: 'Chopsticks, please.', jp: 'お箸をください。', kr: '젓가락 주세요.', th: 'ขอตะเกียบหน่อย' },
                    { label: '叉子', zh: '請給我叉子', en: 'Fork, please.', jp: 'フォークをください。', kr: '포크 주세요.', th: 'ขอส้อมหน่อย' },
                    { label: '紙巾', zh: '請給我紙巾', en: 'Napkin, please.', jp: 'ナプキンをください。', kr: '냅킨 주세요.', th: 'ขอกระดาษทิชชูหน่อย' }
                ]
            },

            // 外帶
            { id: 'dine-takeaway', category: 'dining', zh: '可以外帶嗎？', en: 'Can I take away?', jp: '持ち帰りできますか？', kr: '포장 가능한가요?', th: 'ซื้อกลับได้ไหม?' },
            { id: 'dine-pack', category: 'dining', zh: '請幫我打包', en: 'Please pack this to go.', jp: '持ち帰り用に包んでください。', kr: '포장해 주세요.', th: 'ห่อกลับให้หน่อย' },

            // --- 觀光/景點 (Sightseeing) ---
            { 
                id: 'sight-nearby',
                category: 'sightseeing', 
                isDynamic: true,
                title: '請問附近有...嗎？(尋找地點)', 
                options: [
                    { label: '咖啡廳', zh: '請問附近有咖啡廳嗎？', en: 'Is there a cafe nearby?', jp: '近くにカフェはありますか？', kr: '근처에 카페가 있나요?', th: 'มีคาเฟ่แถวนี้ไหม?' },
                    { label: '教會', zh: '請問附近有基督教會嗎？', en: 'Is there a Christian church nearby?', jp: '近くに教会はありますか？', kr: '근처에 교회가 있나요?', th: 'มีโบสถ์คริสต์แถวนี้ไหม?' },
                    { label: '佛寺', zh: '請問附近有佛寺嗎？', en: 'Is there a Buddhist temple nearby?', jp: '近くにお寺はありますか？', kr: '근처에 절이 있나요?', th: 'มีวัดแถวนี้ไหม?' },
                    { label: '神社', zh: '請問附近有神社嗎？', en: 'Is there a shrine nearby?', jp: '近くに神社はありますか？', kr: '근처에 신사가 있나요?', th: 'มีศาลเจ้าแถวนี้ไหม?' },
                    { label: '遊客中心', zh: '請問遊客中心在哪裡？', en: 'Where is the tourist info center?', jp: '観光案内所はどこですか？', kr: '관광 안내소는 어디예요?', th: 'ศูนย์บริการนักท่องเที่ยวอยู่ที่ไหน?' }
                ]
            },
            { id: 'sight-ticket', category: 'sightseeing', zh: '在哪裡買票？', en: 'Where can I buy tickets?', jp: 'チケットはどこで買えますか？', kr: '표는 어디서 사요?', th: 'ซื้อตั๋วที่ไหน?' },
            { id: 'sight-hours', category: 'sightseeing', zh: '幾點開門/關門？', en: 'What are the opening hours?', jp: '営業時間は何時ですか？', kr: '영업시간이 어떻게 되나요?', th: 'เปิด/ปิดกี่โมง?' },
            { id: 'sight-photo', category: 'sightseeing', zh: '這裡可以拍照嗎？', en: 'Is photography allowed here?', jp: 'ここで写真を撮ってもいいですか？', kr: '여기서 사진 찍어도 되나요?', th: 'ถ่ายรูปที่นี่ได้ไหม?' },
            { id: 'sight-where', category: 'sightseeing', zh: '這個地方在哪裡？', en: 'Where is this place?', jp: 'ここはどこですか？', kr: '여기는 어디인가요?', th: 'ที่นี่ที่ไหน?' },
            { id: 'sight-take-photo', category: 'sightseeing', zh: '可以幫我拍照嗎？', en: 'Could you take a picture of me?', jp: '写真を撮ってもらえますか？', kr: '사진 좀 찍어주시겠어요?', th: 'ช่วยถ่ายรูปให้หน่อยได้ไหม?' },

            // --- 購物 (Shopping) ---
            { id: 'shop-secondhand', category: 'shopping', zh: '請問附近有二手店嗎？', en: 'Is there a second-hand shop nearby?', jp: '近くにリサイクルショップはありますか？', kr: '근처에 중고 가게가 있나요?', th: 'มีร้านมือสองแถวนี้ไหม?' },
            { id: 'shop-discount', category: 'shopping', zh: '算便宜一點好嗎？', en: 'Can you give me a discount?', jp: 'まけてもらえませんか？', kr: '좀 깎아주세요.', th: 'ลดราคาหน่อยได้ไหม?' },
            { id: 'shop-expensive', category: 'shopping', zh: '太貴了', en: 'It is too expensive.', jp: '高すぎます。', kr: '너무 비싸요.', th: 'แพงเกินไป' },
            { id: 'shop-has-discount', category: 'shopping', zh: '有折扣嗎？', en: 'Is there a discount?', jp: '割引はありますか？', kr: '할인이 있나요?', th: 'มีส่วนลดไหม?' },
            { id: 'shop-taxfree', category: 'shopping', zh: '可以退稅嗎？', en: 'Is this tax-free?', jp: '免税にできますか？', kr: '면세가 되나요?', th: 'ขอคืนภาษีได้ไหม?' },
            { id: 'shop-cash', category: 'shopping', zh: '只能付現金', en: 'Cash only, please.', jp: '現金のみです。', kr: '현금만 가능합니다.', th: 'รับเฉพาะเงินสด' },
            { id: 'shop-card', category: 'shopping', zh: '可以用信用卡嗎？', en: 'Credit card accepted?', jp: 'クレジットカードは使えますか？', kr: '카드 결제 되나요?', th: 'รับบัตรเครดิตไหม?' },
            { id: 'shop-price', category: 'shopping', zh: '多少錢？', en: 'How much is this?', jp: 'いくらですか？', kr: '얼마예요?', th: 'ราคาเท่าไหร่?' },
            { id: 'shop-popular', category: 'shopping', zh: '這很受歡迎 (推薦)', en: 'This is very popular.', jp: 'これはとても人気があります。', kr: '이거 아주 인기 있어요.', th: 'อันนี้ขายดีมาก' },

            // --- 緊急/醫療 (Emergency) ---
            { id: 'emg-help', category: 'emergency', zh: '救命！', en: 'Help!', jp: '助けて！', kr: '도와주세요!', th: 'ช่วยด้วย!' },
            { id: 'emg-sick', category: 'emergency', zh: '我不舒服', en: 'I feel sick.', jp: '具合が悪いです。', kr: '몸이 안 좋아요.', th: 'ฉันรู้สึกไม่สบาย' },
            { 
                id: 'emg-lost-item',
                category: 'emergency', 
                isDynamic: true,
                title: '我遺失了... (物品)', 
                options: [
                    { label: '護照', zh: '我遺失了護照', en: 'I lost my passport.', jp: 'パスポートをなくしました。', kr: '여권을 잃어버렸어요.', th: 'ฉันทำพาสปอร์ตหาย' },
                    { label: '錢包', zh: '我遺失了錢包', en: 'I lost my wallet.', jp: '財布をなくしました。', kr: '지갑을 잃어버렸어요.', th: 'ฉันทำกระเป๋าตังค์หาย' },
                    { label: '手機', zh: '我遺失了手機', en: 'I lost my phone.', jp: '携帯をなくしました。', kr: '핸드폰을 잃어버렸어요.', th: 'ฉันทำโทรศัพท์หาย' }
                ]
            },
            { id: 'emg-ambulance', category: 'emergency', zh: '請叫救護車', en: 'Call an ambulance!', jp: '救急車を呼んでください！', kr: '구급차 불러주세요!', th: 'เรียกรถพยาบาลให้หน่อย!' },
            { id: 'emg-police', category: 'emergency', zh: '警察局在哪裡？', en: 'Where is the police station?', jp: '警察署はどこですか？', kr: '경찰서는 어디예요?', th: 'สถานีตำรวจอยู่ที่ไหน?' },
            { id: 'emg-hospital', category: 'emergency', zh: '醫院在哪裡？', en: 'Where is the hospital?', jp: '病院はどこですか？', kr: '병원은 어디예요?', th: 'โรงพยาบาลอยู่ที่ไหน?' },

            // --- 基礎 (Basic) ---
            // 自我介紹國籍
            {
                id: 'int-i-am-from',
                category: 'interaction',
                isDynamic: true,
                title: '我是...人',
                options: [
                    { label: '台灣', zh: '我是台灣人', en: "I'm from Taiwan.", jp: '私は台湾人です。', kr: '저는 대만 사람입니다.', th: 'ฉันมาจากไต้หวัน' },
                    { label: '美國', zh: '我是美國人', en: "I'm American.", jp: '私はアメリカ人です。', kr: '저는 미국 사람입니다.', th: 'ฉันมาจากอเมริกา' },
                    { label: '日本', zh: '我是日本人', en: "I'm Japanese.", jp: '私は日本人です。', kr: '저는 일본 사람입니다.', th: 'ฉันเป็นคนญี่ปุ่น' },
                    { label: '韓國', zh: '我是韓國人', en: "I'm Korean.", jp: '私は韓国人です。', kr: '저는 한국 사람입니다.', th: 'ฉันเป็นคนเกาหลี' },
                    { label: '香港', zh: '我是香港人', en: "I'm from Hong Kong.", jp: '私は香港人です。', kr: '저는 홍콩 사람입니다.', th: 'ฉันมาจากฮ่องกง' },
                    { label: '泰國', zh: '我是泰國人', en: "I'm Thai.", jp: '私はタイ人です。', kr: '저는 태국 사람입니다.', th: 'ฉันเป็นคนไทย' }
                ]
            },
            // 詢問對方國籍
            {
                id: 'int-nationality',
                category: 'interaction',
                isDynamic: true,
                title: '你是...人嗎？',
                options: [
                    { label: '美國', zh: '你是美國人嗎？', en: 'Are you from the US?', jp: 'アメリカの方ですか？', kr: '미국 분이신가요?', th: 'คุณมาจากอเมริกาใช่ไหม?' },
                    { label: '日本', zh: '你是日本人嗎？', en: 'Are you Japanese?', jp: '日本人ですか？', kr: '일본 분이신가요?', th: 'คุณเป็นคนญี่ปุ่นใช่ไหม?' },
                    { label: '韓國', zh: '你是韓國人嗎？', en: 'Are you Korean?', jp: '韓国の方ですか？', kr: '한국 분이신가요?', th: 'คุณเป็นคนเกาหลีใช่ไหม?' },
                    { label: '台灣', zh: '你是台灣人嗎？', en: 'Are you Taiwanese?', jp: '台湾の方ですか？', kr: '대만 분이신가요?', th: 'คุณเป็นคนไต้หวันใช่ไหม?' },
                    { label: '香港', zh: '你是香港人嗎？', en: 'Are you from Hong Kong?', jp: '香港の方ですか？', kr: '홍콩 분이신가요?', th: 'คุณมาจากฮ่องกงใช่ไหม?' },
                    { label: '泰國', zh: '你是泰國人嗎？', en: 'Are you Thai?', jp: 'タイの方ですか？', kr: '태국 분이신가요?', th: 'คุณเป็นคนไทยใช่ไหม?' }
                ]
            },
            {
                id: 'int-greeting',
                category: 'interaction',
                isDynamic: true,
                title: '早安 / 午安 / 晚安',
                options: [
                    { label: '早安', zh: '早安', en: 'Good morning.', jp: 'おはようございます。', kr: '좋은 아침입니다.', th: 'สวัสดีตอนเช้า' },
                    { label: '午安', zh: '你好 / 午安', en: 'Hello / Good afternoon.', jp: 'こんにちは。', kr: '안녕하세요.', th: 'สวัสดี' },
                    { label: '晚安', zh: '晚安', en: 'Good evening.', jp: 'こんばんは。', kr: '좋은 저녁입니다.', th: 'สวัสดีตอนเย็น' }
                ]
            },
            { id: 'int-wait', category: 'interaction', zh: '請稍等一下', en: 'Please wait a moment.', jp: '少々お待ちください。', kr: '잠시만 기다려 주세요.', th: 'กรุณารอสักครู่' },
            { id: 'int-thank-you', category: 'interaction', zh: '謝謝', en: 'Thank you.', jp: 'ありがとうございます。', kr: '감사합니다.', th: 'ขอบคุณ' },
            { id: 'int-excuse-me', category: 'interaction', zh: '不好意思', en: 'Excuse me.', jp: 'すみません。', kr: '실례합니다.', th: 'ขอโทษนะ / ขอทางหน่อย' },

            // --- 交通 (Transport) ---
            { id: 'trans-hotel', category: 'transport', zh: '這家飯店怎麼去？', en: 'How do I get to this hotel?', jp: 'このホテルへはどう行きますか？', kr: '이 호텔은 어떻게 가나요?', th: 'โรงแรมนี้ไปทางไหน?' },
            { id: 'trans-subway', category: 'transport', zh: '地鐵站在哪裡？', en: 'Where is the subway station?', jp: '地下鉄の駅はどこですか？', kr: '지하철역은 어디예요?', th: 'สถานีรถไฟใต้ดินอยู่ที่ไหน?' },
            { id: 'trans-bus-stop', category: 'transport', zh: '巴士站在哪裡？', en: 'Where is the bus stop?', jp: 'バス停はどこですか？', kr: '버스 정류장은 어디예요?', th: 'ป้ายรถเมล์อยู่ที่ไหน?' },
            { id: 'trans-take-me', category: 'transport', zh: '請載我去這裡', en: 'Take me here, please.', jp: 'ここへ行ってください。', kr: '여기로 가주세요.', th: 'ช่วยไปส่งที่นี่หน่อย' },

            // 大眾運輸
            { id: 'trans-airport-bus', category: 'transport', zh: '機場巴士在哪裡？', en: 'Where is the airport bus?', jp: '空港バスはどこですか？', kr: '공항버스는 어디예요?', th: 'รถบัสสนามบินอยู่ที่ไหน?' },
            { id: 'trans-buy-ticket', category: 'transport', zh: '我要買票', en: 'I want to buy a ticket.', jp: 'チケットを買いたいです。', kr: '표를 사고 싶어요.', th: 'ฉันอยากซื้อตั๋ว' },
            {
                id: 'trans-which-line',
                category: 'transport',
                isDynamic: true,
                title: '要搭幾號線？(路線)',
                options: [
                    { label: '到機場', zh: '到機場要搭幾號線？', en: 'Which line goes to the airport?', jp: '空港へは何番線ですか？', kr: '공항 가려면 몇 호선이에요?', th: 'ไปสนามบินต้องขึ้นสายไหน?' },
                    { label: '到車站', zh: '到火車站要搭幾號線？', en: 'Which line goes to the train station?', jp: '駅へは何番線ですか？', kr: '기차역 가려면 몇 호선이에요?', th: 'ไปสถานีรถไฟต้องขึ้นสายไหน?' }
                ]
            },
            { id: 'trans-where-get-off', category: 'transport', zh: '在哪裡下車？', en: 'Where should I get off?', jp: 'どこで降りればいいですか？', kr: '어디서 내려야 하나요?', th: 'ต้องลงที่ไหน?' },
            { id: 'trans-how-long', category: 'transport', zh: '要多久？', en: 'How long does it take?', jp: 'どのくらいかかりますか？', kr: '얼마나 걸려요?', th: 'ใช้เวลานานเท่าไหร่?' },

            // 計程車相關
            { id: 'trans-taxi-receipt', category: 'transport', zh: '請給我收據', en: 'Receipt, please.', jp: '領収書をお願いします。', kr: '영수증 주세요.', th: 'ขอใบเสร็จหน่อย' },
            { id: 'trans-stop-here', category: 'transport', zh: '請在這裡停', en: 'Please stop here.', jp: 'ここで止めてください。', kr: '여기서 세워주세요.', th: 'จอดตรงนี้' },
            { id: 'trans-how-much-fare', category: 'transport', zh: '到那裡要多少錢？', en: 'How much to get there?', jp: 'そこまでいくらですか？', kr: '거기까지 얼마예요?', th: 'ไปที่นั่นเท่าไหร่?' },
            { id: 'trans-mobile-pay', category: 'transport', zh: '可以用手機付款嗎？', en: 'Can I pay by phone?', jp: 'スマホ決済できますか？', kr: '휴대폰으로 결제할 수 있나요?', th: 'จ่ายผ่านมือถือได้ไหม?' },

            // --- 住宿/設施 (Hotel) ---
            { id: 'hotel-wifi', category: 'hotel', zh: '有免費Wi-Fi嗎？', en: 'Is there free Wi-Fi?', jp: '無料Wi-Fiはありますか？', kr: '무료 와이파이 있나요?', th: 'มีไวไฟฟรีไหม?' },
            { id: 'hotel-toilet', category: 'hotel', zh: '洗手間在哪裡？', en: 'Where is the restroom?', jp: 'トイレはどこですか？', kr: '화장실은 어디예요?', th: 'ห้องน้ำอยู่ที่ไหน?' },
            { id: 'hotel-taxi', category: 'hotel', zh: '請幫我叫計程車', en: 'Call a taxi, please.', jp: 'タクシーを呼んでいただけますか？', kr: '택시 좀 불러주세요.', th: 'ช่วยเรียกแท็กซี่ให้หน่อย' },

            // 入住退房
            { id: 'hotel-check-in', category: 'hotel', zh: '我要辦理入住', en: 'I\'d like to check in.', jp: 'チェックインをお願いします。', kr: '체크인하고 싶어요.', th: 'ฉันต้องการเช็คอิน' },
            { id: 'hotel-check-out', category: 'hotel', zh: '我要辦理退房', en: 'I\'d like to check out.', jp: 'チェックアウトをお願いします。', kr: '체크아웃하고 싶어요.', th: 'ฉันต้องการเช็คเอาท์' },
            { id: 'hotel-luggage', category: 'hotel', zh: '可以寄放行李嗎？', en: 'Can I leave my luggage?', jp: '荷物を預かってもらえますか？', kr: '짐을 맡길 수 있나요?', th: 'ฝากกระเป๋าได้ไหม?' },

            // 房間問題
            {
                id: 'hotel-room-problem',
                category: 'hotel',
                isDynamic: true,
                title: '房間...壞了 (設備問題)',
                options: [
                    { label: '冷氣', zh: '冷氣壞了', en: 'The air conditioning is broken.', jp: 'エアコンが壊れています。', kr: '에어컨이 고장났어요.', th: 'แอร์เสีย' },
                    { label: '熱水', zh: '沒有熱水', en: 'There\'s no hot water.', jp: 'お湯が出ません。', kr: '온수가 안 나와요.', th: 'ไม่มีน้ำร้อน' },
                    { label: 'WiFi', zh: 'WiFi連不上', en: 'WiFi doesn\'t work.', jp: 'WiFiが繋がりません。', kr: '와이파이가 안 돼요.', th: 'WiFi ใช้ไม่ได้' }
                ]
            },
            { id: 'hotel-change-room', category: 'hotel', zh: '可以換房間嗎？', en: 'Can I change rooms?', jp: '部屋を変えてもらえますか？', kr: '방을 바꿀 수 있나요?', th: 'เปลี่ยนห้องได้ไหม?' },

            // 飯店服務
            { id: 'hotel-breakfast', category: 'hotel', zh: '早餐幾點開始？', en: 'What time is breakfast?', jp: '朝食は何時からですか？', kr: '조식은 몇 시부터예요?', th: 'อาหารเช้าเริ่มกี่โมง?' },
            { id: 'hotel-towel', category: 'hotel', zh: '可以給我毛巾嗎？', en: 'Can I have more towels?', jp: 'タオルをもらえますか？', kr: '수건 좀 주세요.', th: 'ขอผ้าเช็ดตัวหน่อย' },

            // --- 數字/時間 (Numbers) ---
            {
                id: 'num-count',
                category: 'numbers',
                isDynamic: true,
                title: '數字 1-10',
                options: [
                    { label: '1-5', zh: '一、二、三、四、五', en: 'One, Two, Three, Four, Five', jp: '一、二、三、四、五', kr: '하나, 둘, 셋, 넷, 다섯', th: 'หนึ่ง, สอง, สาม, สี่, ห้า' },
                    { label: '6-10', zh: '六、七、八、九、十', en: 'Six, Seven, Eight, Nine, Ten', jp: '六、七、八、九、十', kr: '여섯, 일곱, 여덟, 아홉, 열', th: 'หก, เจ็ด, แปด, เก้า, สิบ' }
                ]
            },
            {
                id: 'num-large',
                category: 'numbers',
                isDynamic: true,
                title: '大數字',
                options: [
                    { label: '整十', zh: '二十 / 五十 / 一百', en: 'Twenty / Fifty / One hundred', jp: '二十 / 五十 / 百', kr: '이십 / 오십 / 백', th: 'ยี่สิบ / ห้าสิบ / หนึ่งร้อย' },
                    { label: '千萬', zh: '一千 / 一萬', en: 'One thousand / Ten thousand', jp: '千 / 一万', kr: '천 / 만', th: 'พัน / หมื่น' }
                ]
            },
            { id: 'num-time-now', category: 'numbers', zh: '現在幾點？', en: 'What time is it now?', jp: '今何時ですか？', kr: '지금 몇 시예요?', th: 'ตอนนี้กี่โมง?' },
            {
                id: 'num-time',
                category: 'numbers',
                isDynamic: true,
                title: '...點鐘 (時間)',
                options: [
                    { label: '早上', zh: '早上八點', en: '8 AM', jp: '朝8時', kr: '아침 8시', th: '8 โมงเช้า' },
                    { label: '中午', zh: '中午十二點', en: '12 PM (noon)', jp: '正午12時', kr: '낮 12시', th: '12 โมงเที่ยง' },
                    { label: '下午', zh: '下午三點', en: '3 PM', jp: '午後3時', kr: '오후 3시', th: '3 โมงเย็น' },
                    { label: '晚上', zh: '晚上七點', en: '7 PM', jp: '夜7時', kr: '저녁 7시', th: '7 โมงเย็น' }
                ]
            },
            {
                id: 'num-day',
                category: 'numbers',
                isDynamic: true,
                title: '日期',
                options: [
                    { label: '今天', zh: '今天', en: 'Today', jp: '今日', kr: '오늘', th: 'วันนี้' },
                    { label: '明天', zh: '明天', en: 'Tomorrow', jp: '明日', kr: '내일', th: 'พรุ่งนี้' },
                    { label: '昨天', zh: '昨天', en: 'Yesterday', jp: '昨日', kr: '어제', th: 'เมื่อวาน' }
                ]
            },
            {
                id: 'num-week',
                category: 'numbers',
                isDynamic: true,
                title: '星期',
                options: [
                    { label: '週一~三', zh: '星期一 / 二 / 三', en: 'Monday / Tuesday / Wednesday', jp: '月曜日 / 火曜日 / 水曜日', kr: '월요일 / 화요일 / 수요일', th: 'วันจันทร์ / อังคาร / พุธ' },
                    { label: '週四~六', zh: '星期四 / 五 / 六', en: 'Thursday / Friday / Saturday', jp: '木曜日 / 金曜日 / 土曜日', kr: '목요일 / 금요일 / 토요일', th: 'วันพฤหัส / ศุกร์ / เสาร์' },
                    { label: '週日', zh: '星期日', en: 'Sunday', jp: '日曜日', kr: '일요일', th: 'วันอาทิตย์' }
                ]
            }
        ];

        // 分類設定 (新增"常用")
        const categories = [
            { id: 'favorites', name: '常用', icon: 'fa-star' },
            { id: 'all', name: '全部', icon: 'fa-list' },
            { id: 'interaction', name: '互動', icon: 'fa-comments' },
            { id: 'sightseeing', name: '觀光', icon: 'fa-camera' },
            { id: 'dining', name: '餐廳', icon: 'fa-utensils' },
            { id: 'shopping', name: '購物', icon: 'fa-cart-shopping' },
            { id: 'emergency', name: '緊急', icon: 'fa-truck-medical' },
            { id: 'transport', name: '交通', icon: 'fa-train-subway' },
            { id: 'hotel', name: '住宿', icon: 'fa-hotel' },
            { id: 'numbers', name: '數字', icon: 'fa-hashtag' }
        ];

        let currentCategory = 'all';
        let activePhraseData = null;
        let originalDynamicItem = null;
        let searchQuery = '';
        let lastSearchTime = 0; // 用於搜尋 Rate Limiting

        // 讀取我的最愛
        let favorites = JSON.parse(localStorage.getItem('traveltalk_favorites')) || [];

        document.addEventListener('DOMContentLoaded', () => {
            renderCategories();
            renderList();
        });

        // === 安全性函數 ===

        // HTML Escaping - 防止 XSS 攻擊
        function escapeHtml(unsafe) {
            if (typeof unsafe !== 'string') return '';
            return unsafe
                .replace(/&/g, "&amp;")
                .replace(/</g, "&lt;")
                .replace(/>/g, "&gt;")
                .replace(/"/g, "&quot;")
                .replace(/'/g, "&#039;");
        }

        // 驗證搜尋輸入
        function validateSearchInput(text) {
            // 1. 長度限制
            if (text.length > 100) {
                return { valid: false, message: '搜尋關鍵字過長' };
            }

            // 2. 阻擋明顯的 HTML 標籤
            if (/<[^>]*>/g.test(text)) {
                return { valid: false, message: '搜尋內容包含非法字符' };
            }

            // 3. 阻擋 JavaScript 關鍵字
            const dangerousPatterns = [
                /javascript:/i,
                /on\w+\s*=/i,  // onload=, onclick=, etc.
                /<script/i,
                /<iframe/i
            ];

            for (const pattern of dangerousPatterns) {
                if (pattern.test(text)) {
                    return { valid: false, message: '搜尋內容包含非法字符' };
                }
            }

            return { valid: true };
        }

        // 搜尋功能
        function handleSearch() {
            // Rate Limiting：防止快速連續搜尋
            const now = Date.now();
            const SEARCH_COOLDOWN = 500; // 500ms 冷卻時間

            if (now - lastSearchTime < SEARCH_COOLDOWN) {
                return; // 靜默忽略，不顯示錯誤
            }
            lastSearchTime = now;

            const input = document.getElementById('search-input');
            const clearBtn = document.getElementById('clear-search');
            const rawText = input.value.trim();

            // 驗證輸入
            if (rawText) {
                const validation = validateSearchInput(rawText);
                if (!validation.valid) {
                    showVoiceWarning('搜尋失敗', validation.message);
                    input.value = '';
                    searchQuery = '';
                    clearBtn.classList.add('hidden');
                    renderList();
                    return;
                }
            }

            searchQuery = rawText.toLowerCase();

            // 顯示/隱藏清除按鈕
            if (searchQuery) {
                clearBtn.classList.remove('hidden');
            } else {
                clearBtn.classList.add('hidden');
            }

            renderList();
        }

        function clearSearch() {
            const input = document.getElementById('search-input');
            input.value = '';
            handleSearch();
        }

        // 收藏功能 (Toggle)
        function toggleFavorite(id, event) {
            // 阻止冒泡，避免觸發卡片點擊
            if (event) event.stopPropagation();

            if (favorites.includes(id)) {
                favorites = favorites.filter(favId => favId !== id);
            } else {
                favorites.push(id);
            }
            
            // 儲存到 LocalStorage
            localStorage.setItem('traveltalk_favorites', JSON.stringify(favorites));
            
            renderList(); // 重新渲染以更新星星狀態和排序
        }

        function renderCategories() {
            const container = document.getElementById('category-container');
            container.innerHTML = categories.map(cat => {
                const isActive = currentCategory === cat.id;
                // 特殊樣式給"常用"
                const activeClass = cat.id === 'favorites' 
                    ? (isActive ? 'bg-yellow-500 text-white shadow-md' : 'bg-yellow-100 text-yellow-700 hover:bg-yellow-200')
                    : (isActive ? 'bg-blue-600 text-white shadow-md' : 'bg-gray-200 text-gray-600 hover:bg-gray-300');

                return `
                <button onclick="setCategory('${cat.id}')"
                    class="px-4 py-2 rounded-full text-sm font-bold whitespace-nowrap transition flex items-center gap-2 select-none ${activeClass}">
                    <i class="fa-solid ${cat.icon}"></i> ${cat.name}
                </button>
            `}).join('');
        }

        function setCategory(id) {
            currentCategory = id;
            // 清除搜尋 (切換分類時通常希望重置搜尋，或者你可以保留)
            // 這裡選擇不清除搜尋，讓使用者可以在分類中搜尋
            renderCategories();
            renderList();
        }

        function renderList() {
            const list = document.getElementById('content-list');
            let items = phrases;

            // 1. 先過濾分類
            if (currentCategory === 'favorites') {
                items = items.filter(p => favorites.includes(p.id));
            } else if (currentCategory !== 'all') {
                items = items.filter(p => p.category === currentCategory);
            }

            // 2. 再過濾搜尋關鍵字
            if (searchQuery) {
                items = items.filter(p => {
                    const searchContent = [
                        p.zh, p.en, p.jp, p.kr, p.th, p.title,
                        // 如果是動態卡片，也要搜尋裡面的選項
                        ...(p.isDynamic ? p.options.map(o => o.label + o.zh + o.en) : [])
                    ].join(' ').toLowerCase();
                    return searchContent.includes(searchQuery);
                });
            }
            
            // 3. 排序邏輯
            const categoryOrder = { 'interaction': 1, 'sightseeing': 2, 'dining': 3, 'shopping': 4, 'emergency': 5 };
            
            items.sort((a, b) => {
                const aFav = favorites.includes(a.id);
                const bFav = favorites.includes(b.id);

                // 規則A: 在任何列表中，已收藏的項目永遠置頂
                if (aFav && !bFav) return -1;
                if (!aFav && bFav) return 1;

                // 規則B: 正常的分類排序 (僅在 All 模式下生效)
                if (currentCategory === 'all') {
                    const orderA = categoryOrder[a.category] || 99;
                    const orderB = categoryOrder[b.category] || 99;
                    if (orderA !== orderB) return orderA - orderB;
                }
                
                // 規則C: 動態卡片優先
                return (b.isDynamic ? 1 : 0) - (a.isDynamic ? 1 : 0);
            });

            if (items.length === 0) {
                // 清空列表
                list.innerHTML = '';

                if (currentCategory === 'favorites') {
                    // 收藏清單為空
                    const emptyDiv = document.createElement('div');
                    emptyDiv.className = 'text-center text-gray-400 mt-20';
                    emptyDiv.innerHTML = '<p>還沒有加入常用對話<br><span class="text-xs">點擊星星圖示即可加入</span></p>';
                    list.appendChild(emptyDiv);
                } else if (searchQuery) {
                    // 搜尋失敗 - 使用 DOM API 安全建立元素
                    const container = document.createElement('div');
                    container.className = 'text-center mt-20';

                    // 錯誤訊息
                    const messageDiv = document.createElement('div');
                    messageDiv.className = 'text-gray-400 mb-6';

                    const icon = document.createElement('i');
                    icon.className = 'fa-solid fa-magnifying-glass text-4xl mb-2';
                    messageDiv.appendChild(icon);

                    const p = document.createElement('p');
                    p.className = 'text-lg';
                    p.textContent = '找不到「';

                    const searchSpan = document.createElement('span');
                    searchSpan.className = 'text-gray-600 font-bold';
                    searchSpan.textContent = searchQuery; // 使用 textContent，安全

                    p.appendChild(searchSpan);
                    p.appendChild(document.createTextNode('」相關內容 😢'));
                    messageDiv.appendChild(p);

                    container.appendChild(messageDiv);

                    // Google 翻譯區塊
                    const translateSection = document.createElement('div');
                    translateSection.className = 'mb-6';

                    // 主按鈕：翻譯成英文
                    const GOOGLE_BASE = 'https://translate.google.com/';
                    const encodedText = encodeURIComponent(searchQuery);

                    const mainTranslateBtn = document.createElement('a');
                    mainTranslateBtn.href = `${GOOGLE_BASE}?sl=zh-TW&tl=en&text=${encodedText}`;
                    mainTranslateBtn.target = '_blank';
                    mainTranslateBtn.rel = 'noopener noreferrer';
                    mainTranslateBtn.className = 'inline-block bg-green-600 text-white px-6 py-3 rounded-lg font-bold shadow-md hover:bg-green-700 mb-3';
                    mainTranslateBtn.innerHTML = '<i class="fa-solid fa-language"></i> 翻譯成英文（Google）';

                    translateSection.appendChild(mainTranslateBtn);

                    // 其他語言選項（小字連結）
                    const otherLangs = document.createElement('div');
                    otherLangs.className = 'text-sm text-gray-500';
                    otherLangs.appendChild(document.createTextNode('或翻譯成：'));

                    const languages = [
                        { code: 'ja', name: '日文' },
                        { code: 'ko', name: '韓文' },
                        { code: 'th', name: '泰文' }
                    ];

                    languages.forEach((lang, idx) => {
                        if (idx > 0) {
                            otherLangs.appendChild(document.createTextNode(' | '));
                        }

                        const link = document.createElement('a');
                        link.href = `${GOOGLE_BASE}?sl=zh-TW&tl=${lang.code}&text=${encodedText}`;
                        link.target = '_blank';
                        link.rel = 'noopener noreferrer';
                        link.className = 'text-blue-600 hover:underline';
                        link.textContent = lang.name;

                        otherLangs.appendChild(link);
                    });

                    translateSection.appendChild(otherLangs);
                    container.appendChild(translateSection);

                    // 分隔線
                    const divider = document.createElement('div');
                    divider.className = 'border-t border-gray-300 my-6 mx-auto w-64';
                    container.appendChild(divider);

                    // 建議新增場景按鈕
                    const suggestBtn = document.createElement('button');
                    suggestBtn.className = 'bg-blue-600 text-white px-6 py-3 rounded-lg font-bold shadow-md hover:bg-blue-700';
                    suggestBtn.innerHTML = '<i class="fa-solid fa-lightbulb"></i> 建議新增這個場景';
                    suggestBtn.addEventListener('click', () => suggestFromSearch(searchQuery));

                    container.appendChild(suggestBtn);
                    list.appendChild(container);
                } else {
                    // 一般空白狀態
                    const emptyDiv = document.createElement('div');
                    emptyDiv.className = 'text-center text-gray-400 mt-20';
                    emptyDiv.innerHTML = '<p>沒有找到相關內容</p>';
                    list.appendChild(emptyDiv);
                }
                return;
            }

            list.innerHTML = items.map((item) => {
                const displayTitle = item.isDynamic ? item.title : item.zh;
                const subTitle = item.isDynamic ? '點擊切換多種選項' : item.en;
                
                // 檢查是否收藏
                const isFav = favorites.includes(item.id);
                const starIconClass = isFav ? "fa-solid fa-star text-yellow-500" : "fa-regular fa-star text-gray-400 hover:text-yellow-500";
                
                let borderClass = 'border border-gray-100';
                // 如果已收藏，給個金色邊框提示
                if (isFav) {
                    borderClass = 'border-l-4 border-l-yellow-400 border-y border-r border-yellow-100 bg-yellow-50/50';
                } else {
                    if (item.category === 'interaction') borderClass = 'border-l-4 border-l-blue-400 border-y border-r border-gray-100';
                    if (item.category === 'sightseeing') borderClass = 'border-l-4 border-l-purple-500 border-y border-r border-gray-100';
                    if (item.category === 'dining') borderClass = 'border-l-4 border-l-orange-400 border-y border-r border-gray-100';
                    if (item.category === 'emergency') borderClass = 'border-l-4 border-l-red-500 border-y border-r border-gray-100';
                    if (item.category === 'shopping') borderClass = 'border-l-4 border-l-green-400 border-y border-r border-gray-100'; 
                }
                
                // 為了傳遞物件，我們這次改用 ID 查找
                // 因為現在有搜尋過濾，原本的 index 會亂掉
                return `
                <div onclick="openModalById('${item.id}')" class="bg-white p-4 mb-3 rounded-xl shadow-sm ${borderClass} active:bg-gray-100 transition cursor-pointer flex justify-between items-center group select-none relative">
                    <div class="flex-1 pr-4">
                        <div class="flex items-center gap-2">
                            ${item.isDynamic ? '<i class="fa-solid fa-layer-group text-blue-500 text-xs"></i>' : ''}
                            <h3 class="text-lg font-bold text-gray-800 mb-1 leading-tight">${displayTitle}</h3>
                        </div>
                        <p class="text-xs text-gray-400 truncate font-medium">${subTitle}</p>
                    </div>
                    
                    <!-- 收藏按鈕 (絕對定位在右下，避免誤觸展開) -->
                    <div class="flex items-center gap-3">
                         <button onclick="toggleFavorite('${item.id}', event)" class="w-10 h-10 flex items-center justify-center rounded-full hover:bg-gray-100 transition z-10">
                            <i class="${starIconClass} text-lg transition-transform active:scale-125"></i>
                        </button>
                        <div class="text-blue-500 bg-blue-50 w-10 h-10 flex items-center justify-center rounded-full group-hover:bg-blue-600 group-hover:text-white transition shrink-0">
                            <i class="fa-solid ${item.isDynamic ? 'fa-sliders' : 'fa-expand'}"></i>
                        </div>
                    </div>
                </div>
            `}).join('');
        }

        // --- Modal Logic ---

        function openModalById(id) {
            const item = phrases.find(p => p.id === id);
            if (!item) return;

            const modal = document.getElementById('translation-modal');
            const switcher = document.getElementById('modal-switcher');
            
            modal.classList.remove('hidden');
            modal.classList.add('flex');

            if (item.isDynamic) {
                originalDynamicItem = item;
                switcher.classList.remove('hidden');
                switcher.classList.add('grid');
                
                const count = item.options.length;
                let cols = 'grid-cols-3';
                if (count <= 2) cols = 'grid-cols-2';
                if (count >= 4) cols = 'grid-cols-4';
                
                switcher.className = `grid gap-2 mb-4 ${cols}`;

                switcher.innerHTML = item.options.map((opt, idx) => `
                    <button onclick="switchDynamicOption(${idx})" class="py-2 text-xs font-bold rounded border transition tab-inactive truncate">
                        ${opt.label}
                    </button>
                `).join('');

                switchDynamicOption(0);

            } else {
                originalDynamicItem = null;
                activePhraseData = item;
                switcher.classList.add('hidden');
                switcher.classList.remove('grid');
                updateModalText(item);
            }
        }

        function switchDynamicOption(subIndex) {
            if (!originalDynamicItem) return;
            
            const buttons = document.querySelectorAll('#modal-switcher button');
            buttons.forEach((btn, idx) => {
                if (idx === subIndex) {
                    btn.classList.remove('tab-inactive');
                    btn.classList.add('tab-active');
                } else {
                    btn.classList.add('tab-inactive');
                    btn.classList.remove('tab-active');
                }
            });

            activePhraseData = originalDynamicItem.options[subIndex];
            updateModalText(activePhraseData);
        }

        function updateModalText(data) {
            document.getElementById('modal-zh').textContent = data.zh;
            document.getElementById('modal-en').textContent = data.en;
            document.getElementById('modal-jp').textContent = data.jp;
            document.getElementById('modal-kr').textContent = data.kr;
            document.getElementById('modal-th').textContent = data.th || '';
        }

        function closeModal() {
            const modal = document.getElementById('translation-modal');
            modal.classList.add('hidden');
            modal.classList.remove('flex');
            window.speechSynthesis.cancel();
        }
        
        let voices = [];
        let voiceAvailability = {
            'en-US': false,
            'ja-JP': false,
            'ko-KR': false,
            'th-TH': false
        };

        function loadVoices() {
            voices = window.speechSynthesis.getVoices();

            // 檢測各語言是否有可用語音
            voiceAvailability['en-US'] = voices.some(v => v.lang.startsWith('en'));
            voiceAvailability['ja-JP'] = voices.some(v => v.lang.startsWith('ja'));
            voiceAvailability['ko-KR'] = voices.some(v => v.lang.startsWith('ko'));
            voiceAvailability['th-TH'] = voices.some(v => v.lang.startsWith('th'));

            updateVoiceIndicators();
        }

        function updateVoiceIndicators() {
            // 在彈窗中顯示語音可用性（如果需要）
            const indicators = {
                'en': voiceAvailability['en-US'],
                'ja': voiceAvailability['ja-JP'],
                'ko': voiceAvailability['ko-KR'],
                'th': voiceAvailability['th-TH']
            };
        }

        if ('speechSynthesis' in window) {
            loadVoices();
            if (window.speechSynthesis.onvoiceschanged !== undefined) {
                window.speechSynthesis.onvoiceschanged = loadVoices;
            }

            // Android 設備需要初次用戶互動來啟動 TTS
            document.addEventListener('click', function initTTS() {
                if (voices.length === 0) {
                    loadVoices();
                }
            }, { once: true });
        }

        function playAudio(lang) {
            if (!activePhraseData) return;

            // Android Chrome 需要先 cancel 再等一下
            window.speechSynthesis.cancel();

            let text = '';
            let langCode = '';
            let langName = '';
            switch(lang) {
                case 'en':
                    text = activePhraseData.en;
                    langCode = 'en-US';
                    langName = '英文';
                    break;
                case 'ja':
                    text = activePhraseData.jp;
                    langCode = 'ja-JP';
                    langName = '日文';
                    break;
                case 'ko':
                    text = activePhraseData.kr;
                    langCode = 'ko-KR';
                    langName = '韓文';
                    break;
                case 'th':
                    text = activePhraseData.th;
                    langCode = 'th-TH';
                    langName = '泰文';
                    break;
            }

            if (!('speechSynthesis' in window)) {
                showVoiceWarning('您的瀏覽器不支援語音播放', '請使用 Chrome 或 Safari 瀏覽器');
                return;
            }

            // Android 需要稍微延遲
            const isAndroid = /Android/i.test(navigator.userAgent);
            const delay = isAndroid ? 150 : 0;

            setTimeout(() => {
                // 確保 voices 已載入
                if (voices.length === 0) {
                    voices = window.speechSynthesis.getVoices();
                    loadVoices(); // 更新可用性狀態
                }

                // 檢查是否有該語言的語音包
                const hasVoice = voices.some(v => {
                    const vLang = v.lang.replace('_', '-');
                    return vLang === langCode || vLang.startsWith(langCode.split('-')[0]);
                });

                if (!hasVoice) {
                    showVoiceWarning(
                        `您的設備未安裝${langName}語音包`,
                        isAndroid
                            ? `請至：設定 → 系統 → 語言和輸入法 → 文字轉語音輸出\n\n下載「${langName}」語音引擎後重新整理網頁`
                            : `請至：設定 → 輔助使用 → 語音內容 → 聲音\n\n下載「${langName}」語音包後重新整理網頁`
                    );
                    return;
                }

                const utterance = new SpeechSynthesisUtterance(text);
                utterance.lang = langCode;
                utterance.rate = 0.9;
                utterance.pitch = 1.0;
                utterance.volume = 1.0;

                // 嘗試找到最適合的語音（優先非中文語音，避免用中文讀外語）
                const targetVoice = voices.find(v => {
                    const vLang = v.lang.replace('_', '-');
                    // 完全匹配優先
                    if (vLang === langCode) return true;
                    // 語言前綴匹配（如 en-US, en-GB）
                    if (vLang.startsWith(langCode.split('-')[0])) return true;
                    return false;
                });

                if (targetVoice) {
                    utterance.voice = targetVoice;
                    console.log(`使用語音: ${targetVoice.name} (${targetVoice.lang})`);
                }

                // 錯誤處理
                utterance.onerror = (event) => {
                    // "canceled" 是正常情況（用戶切換語言或快速點擊），不需要顯示錯誤
                    if (event.error === 'canceled') {
                        console.log('語音播放被取消（正常）');
                        return;
                    }

                    // "interrupted" 也是正常情況（被新的播放打斷）
                    if (event.error === 'interrupted') {
                        console.log('語音播放被中斷（正常）');
                        return;
                    }

                    console.error('語音播放錯誤:', event);

                    if (event.error === 'not-allowed') {
                        showVoiceWarning('無法播放聲音', '請確認已允許網頁播放聲音');
                    } else if (event.error === 'language-unavailable') {
                        showVoiceWarning(
                            `${langName}語音不可用`,
                            '請在系統設定中下載對應的語音包'
                        );
                    } else if (event.error === 'network') {
                        showVoiceWarning('網路錯誤', '請檢查網路連線後重試');
                    } else if (event.error === 'synthesis-failed') {
                        showVoiceWarning('播放失敗', '語音合成失敗，請稍後再試');
                    } else {
                        // 其他未知錯誤才顯示
                        showVoiceWarning('播放失敗', `錯誤代碼: ${event.error}`);
                    }
                };

                // 播放開始事件（用於除錯）
                utterance.onstart = () => {
                    console.log(`開始播放: ${text}`);
                };

                // Android Chrome 的 workaround
                if (isAndroid) {
                    window.speechSynthesis.resume();
                }

                window.speechSynthesis.speak(utterance);

            }, delay);
        }

        // 顯示自動消失的 Toast 通知
        function showVoiceWarning(title, message) {
            const toastId = 'toast-' + Date.now();
            const toastHtml = `
                <div id="${toastId}" class="fixed top-20 left-1/2 transform -translate-x-1/2 z-[60] max-w-sm w-[calc(100%-2rem)] mx-auto opacity-0 transition-all duration-300">
                    <div class="bg-white rounded-xl p-4 shadow-2xl border border-gray-200">
                        <div class="flex items-start gap-3">
                            <div class="flex-shrink-0 w-6 h-6 flex items-center justify-center rounded-full bg-orange-100">
                                <i class="fa-solid fa-exclamation text-orange-600 text-sm"></i>
                            </div>
                            <div class="flex-1 min-w-0">
                                <h4 class="text-sm font-bold text-gray-800 mb-1">${title}</h4>
                                <p class="text-xs text-gray-600 leading-relaxed whitespace-pre-line">${message}</p>
                            </div>
                            <button onclick="document.getElementById('${toastId}').remove()" class="flex-shrink-0 text-gray-400 hover:text-gray-600">
                                <i class="fa-solid fa-xmark text-sm"></i>
                            </button>
                        </div>
                    </div>
                </div>
            `;

            document.body.insertAdjacentHTML('beforeend', toastHtml);

            const toast = document.getElementById(toastId);

            // 淡入動畫
            setTimeout(() => {
                toast.style.opacity = '1';
                toast.style.top = '5rem';
            }, 10);

            // 4 秒後自動消失
            setTimeout(() => {
                toast.style.opacity = '0';
                toast.style.top = '4rem';
                setTimeout(() => toast.remove(), 300);
            }, 4000);
        }
        
        // 檢測語音包可用性
        function checkVoiceAvailability() {
            // 確保 voices 已載入
            if (voices.length === 0) {
                voices = window.speechSynthesis.getVoices();
                loadVoices();
            }

            const langTests = [
                { code: 'en-US', name: '英文 (English)', prefix: 'en' },
                { code: 'ja-JP', name: '日文 (日本語)', prefix: 'ja' },
                { code: 'ko-KR', name: '韓文 (한국어)', prefix: 'ko' },
                { code: 'th-TH', name: '泰文 (ไทย)', prefix: 'th' }
            ];

            let resultsHtml = '<div class="space-y-2 text-left mb-4">';

            langTests.forEach(lang => {
                const hasVoice = voices.some(v => {
                    const vLang = v.lang.replace('_', '-');
                    return vLang === lang.code || vLang.startsWith(lang.prefix);
                });

                const voiceList = voices
                    .filter(v => v.lang.replace('_', '-').startsWith(lang.prefix))
                    .map(v => v.name)
                    .slice(0, 2);

                const icon = hasVoice
                    ? '<i class="fa-solid fa-circle-check text-green-500"></i>'
                    : '<i class="fa-solid fa-circle-xmark text-red-500"></i>';

                const status = hasVoice
                    ? `<span class="text-green-700 font-bold">已安裝</span>`
                    : `<span class="text-red-600 font-bold">未安裝</span>`;

                const details = hasVoice && voiceList.length > 0
                    ? `<div class="text-[10px] text-gray-500 ml-6 mt-1">可用: ${voiceList.join(', ')}</div>`
                    : '';

                resultsHtml += `
                    <div class="flex items-start gap-2 p-2 rounded bg-gray-50">
                        <div class="mt-0.5">${icon}</div>
                        <div class="flex-1">
                            <div class="text-sm font-medium text-gray-800">${lang.name}</div>
                            <div class="text-xs">${status}</div>
                            ${details}
                        </div>
                    </div>
                `;
            });

            resultsHtml += '</div>';

            const isAndroid = /Android/i.test(navigator.userAgent);
            const deviceTip = isAndroid
                ? '<p class="text-xs text-gray-600 mb-3">Android 用戶請至：<br><b>設定 → 系統 → 語言和輸入法 → 文字轉語音輸出</b><br>下載 Google 文字轉語音引擎與對應語言</p>'
                : '<p class="text-xs text-gray-600 mb-3">iPhone 用戶請至：<br><b>設定 → 輔助使用 → 語音內容 → 聲音</b><br>下載對應語言的語音包</p>';

            const totalAvailable = langTests.filter(lang =>
                voices.some(v => v.lang.replace('_', '-').startsWith(lang.prefix))
            ).length;

            const alertHtml = `
                <div id="voice-check-result" class="fixed inset-0 z-[70] flex items-center justify-center bg-black/50 backdrop-blur-sm p-4">
                    <div class="bg-white rounded-xl p-6 max-w-md w-full shadow-2xl max-h-[90vh] overflow-y-auto">
                        <h3 class="text-xl font-bold text-gray-800 mb-2">語音包檢測結果</h3>
                        <p class="text-sm text-gray-600 mb-4">共偵測到 ${totalAvailable}/4 種語言可用</p>

                        ${resultsHtml}

                        ${deviceTip}

                        <p class="text-xs text-gray-500 mb-4">*下載語音包後請重新整理網頁</p>

                        <button onclick="document.getElementById('voice-check-result').remove()"
                            class="w-full bg-blue-600 text-white font-bold py-3 rounded-lg">
                            關閉
                        </button>
                    </div>
                </div>
            `;

            document.body.insertAdjacentHTML('beforeend', alertHtml);
        }

        // Added showInfo function to fix ReferenceError
        function showInfo() {
            document.getElementById('info-modal').classList.remove('hidden');
        }

        // === 建議功能相關函數 ===

        // 驗證建議內容
        function validateSuggestion(text) {
            // 1. 基本檢查
            if (!text || text.trim().length === 0) {
                return { valid: false, message: '請輸入建議內容' };
            }

            // 2. 長度限制
            const length = text.trim().length;
            if (length < 5) {
                return { valid: false, message: '建議內容至少 5 個字' };
            }
            if (length > 100) {
                return { valid: false, message: '建議內容不能超過 100 字' };
            }

            // 3. 過濾重複字符（aaaaaaa）
            if (/(.)\1{4,}/.test(text)) {
                return { valid: false, message: '請輸入有意義的內容' };
            }

            // 4. 過濾純符號或亂碼
            if (/^[^\w\u4e00-\u9fa5]+$/.test(text)) {
                return { valid: false, message: '請輸入文字內容' };
            }

            // 5. 過濾純數字
            if (/^\d+$/.test(text)) {
                return { valid: false, message: '請輸入有意義的建議' };
            }

            // 6. 阻擋 HTML 標籤（安全性）
            if (/<[^>]*>/g.test(text)) {
                return { valid: false, message: '請勿輸入 HTML 標籤' };
            }

            // 7. 阻擋 JavaScript 關鍵字（安全性）
            if (/javascript:/i.test(text) || /on\w+\s*=/i.test(text)) {
                return { valid: false, message: '建議內容包含非法字符' };
            }

            // 8. 阻擋 URL（防止釣魚連結）
            if (/(https?:\/\/|www\.)/i.test(text)) {
                return { valid: false, message: '請勿在建議中包含網址' };
            }

            return { valid: true };
        }

        // 檢查隱私風險
        function checkPrivacyRisk(text) {
            // 偵測電話號碼
            if (/\d{9,11}/.test(text)) {
                return '內容疑似包含電話號碼';
            }
            // 偵測 Email
            if (/@.+\..+/.test(text)) {
                return '內容疑似包含 Email';
            }
            // 偵測身分證格式（台灣）
            if (/[A-Z]\d{9}/.test(text)) {
                return '內容疑似包含身分證字號';
            }
            return null;
        }

        // 檢查 Rate Limiting（一小時 20 次）
        function canSubmitSuggestion() {
            const LIMIT = 20; // 一小時最多 20 次
            const WINDOW = 60 * 60 * 1000; // 一小時（毫秒）

            // 從 localStorage 讀取送出記錄
            const historyStr = localStorage.getItem('suggestion_history');
            let history = historyStr ? JSON.parse(historyStr) : [];

            // 過濾掉一小時前的記錄
            const now = Date.now();
            history = history.filter(timestamp => now - timestamp < WINDOW);

            // 檢查是否超過限制
            if (history.length >= LIMIT) {
                // 找出最早的記錄，計算何時可以再送出
                const oldestTimestamp = Math.min(...history);
                const nextAvailableTime = oldestTimestamp + WINDOW;
                const waitTime = nextAvailableTime - now;
                const waitMinutes = Math.ceil(waitTime / (60 * 1000));

                return {
                    canSubmit: false,
                    message: `您已達到一小時 ${LIMIT} 次的上限，請 ${waitMinutes} 分鐘後再試`
                };
            }

            // 更新 localStorage（清理舊記錄）
            localStorage.setItem('suggestion_history', JSON.stringify(history));

            return {
                canSubmit: true,
                remaining: LIMIT - history.length // 剩餘次數
            };
        }

        // 記錄送出時間
        function recordSubmission() {
            const historyStr = localStorage.getItem('suggestion_history');
            let history = historyStr ? JSON.parse(historyStr) : [];

            // 添加當前時間戳記
            history.push(Date.now());

            // 只保留最近 20 筆（避免無限增長）
            if (history.length > 20) {
                history = history.slice(-20);
            }

            localStorage.setItem('suggestion_history', JSON.stringify(history));
        }

        // 送出 GA Event
        function sendGAEvent(eventName, params) {
            if (typeof gtag !== 'undefined') {
                gtag('event', eventName, params);
                console.log('GA Event 已送出:', eventName, params);
            } else {
                console.warn('GA 未初始化，無法送出 event');
            }
        }

        // 統一的建議送出邏輯（DRY 原則）
        function processSuggestion(text, source) {
            // source: 'search' | 'manual'

            // 1. 驗證內容
            const validation = validateSuggestion(text);
            if (!validation.valid) {
                showVoiceWarning('無法送出建議', validation.message);
                return false;
            }

            // 2. 檢查 rate limiting
            const rateLimitCheck = canSubmitSuggestion();
            if (!rateLimitCheck.canSubmit) {
                showVoiceWarning('送出太頻繁', rateLimitCheck.message);
                return false;
            }

            // 3. 檢查隱私風險
            const privacyRisk = checkPrivacyRisk(text);
            if (privacyRisk) {
                console.warn('建議包含隱私風險:', privacyRisk, text);

                // 如果是手動輸入，在 modal 中顯示警告（但不阻擋）
                if (source === 'manual') {
                    const warningDiv = document.getElementById('suggestion-warning');
                    const warningText = document.getElementById('suggestion-warning-text');
                    warningText.textContent = privacyRisk;
                    warningDiv.classList.remove('hidden');
                }
                // 不阻擋送出，只是警告
            }

            // 4. 送出 GA Event
            if (source === 'search') {
                sendGAEvent('search_not_found', {
                    search_keyword: text,
                    event_category: 'user_suggestion',
                    event_label: `搜尋建議: ${text}`
                });
            } else if (source === 'manual') {
                sendGAEvent('user_suggestion', {
                    event_category: 'user_suggestion',
                    event_label: `手動建議: ${text}`,
                    suggestion_text: text
                });
            }

            // 5. 記錄送出
            recordSubmission();

            // 6. 顯示感謝訊息
            showVoiceWarning('感謝您的建議！',
                source === 'search' ? '我們會盡快新增相關內容' : '您的意見將幫助我們改進 TravelTalk');

            return true;
        }

        // 從搜尋建議（點擊按鈕時）
        function suggestFromSearch(keyword) {
            // 打開 info modal
            const modal = document.getElementById('info-modal');
            modal.classList.remove('hidden');

            // 設定建議輸入框的值
            const input = document.getElementById('suggestion-input');
            input.value = keyword;

            // Focus 到輸入框
            setTimeout(() => {
                input.focus();
                // 將游標移到文字最後
                input.setSelectionRange(input.value.length, input.value.length);
            }, 100); // 短暫延遲確保 modal 已開啟
        }

        // 手動送出建議（從 modal）
        function submitSuggestion() {
            const input = document.getElementById('suggestion-input');
            const warningDiv = document.getElementById('suggestion-warning');
            const text = input.value.trim();

            // 隱藏之前的警告
            warningDiv.classList.add('hidden');

            // 調用統一邏輯
            const success = processSuggestion(text, 'manual');

            // 如果成功送出，清空輸入框
            if (success) {
                input.value = '';
                warningDiv.classList.add('hidden');
            }
        }

        // ===== Service Worker 註冊 =====
        if ('serviceWorker' in navigator) {
            window.addEventListener('load', () => {
                navigator.serviceWorker.register('/sw.js')
                    .then((registration) => {
                        console.log('✅ Service Worker registered:', registration.scope);

                        // 檢查更新
                        registration.addEventListener('updatefound', () => {
                            const newWorker = registration.installing;
                            console.log('🔄 New Service Worker installing...');

                            newWorker.addEventListener('statechange', () => {
                                if (newWorker.state === 'installed' && navigator.serviceWorker.controller) {
                                    // 有新版本可用
                                    showUpdateNotification();
                                }
                            });
                        });
                    })
                    .catch((error) => {
                        console.error('❌ Service Worker registration failed:', error);
                    });
            });
        }

        // 顯示更新通知
        function showUpdateNotification() {
            showVoiceWarning('新版本可用', '請重新整理頁面以更新應用', 5000);
        }

        // ===== 網路狀態檢測 =====
        let isOnline = navigator.onLine;

        function updateOnlineStatus() {
            isOnline = navigator.onLine;
            const offlineIndicator = document.getElementById('offline-indicator');

            if (!isOnline && !offlineIndicator) {
                // 顯示離線指示器
                const indicator = document.createElement('div');
                indicator.id = 'offline-indicator';
                indicator.style.cssText = `
                    position: fixed;
                    bottom: 80px;
                    left: 50%;
                    transform: translateX(-50%);
                    background: #f59e0b;
                    color: white;
                    padding: 8px 16px;
                    border-radius: 20px;
                    font-size: 12px;
                    z-index: 100;
                    box-shadow: 0 2px 8px rgba(0,0,0,0.2);
                    display: flex;
                    align-items: center;
                    gap: 8px;
                `;
                indicator.innerHTML = '<i class="fa-solid fa-wifi-slash"></i><span>離線模式</span>';
                document.body.appendChild(indicator);
            } else if (isOnline && offlineIndicator) {
                // 移除離線指示器
                offlineIndicator.remove();
            }
        }

        window.addEventListener('online', () => {
            updateOnlineStatus();
            showVoiceWarning('已恢復網路連線', '', 2000);
        });

        window.addEventListener('offline', () => {
            updateOnlineStatus();
            showVoiceWarning('目前處於離線模式', '核心翻譯功能仍可使用', 3000);
        });

        // 初始化
        updateOnlineStatus();
    </script>
</body>
</html>
